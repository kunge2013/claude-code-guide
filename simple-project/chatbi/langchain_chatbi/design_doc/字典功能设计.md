# 字典功能设计文档

## 1. 需求概述

### 1.1 业务场景

当用户问"云总机有哪些配置"时，系统需要：
1. 将"云总机"转换为产品ID `1001`
2. 使用转换后的ID查询 `special_settlement_rule_config` 表

### 1.2 核心需求

| 需求 | 说明 |
|------|------|
| 值转换 | 业务名称 → 数据库编码的自动转换 |
| 数据来源 | 混合模式：数据库动态查询 + 静态配置 |
| 同义词支持 | 支持多个名称映射到同一编码 |
| 转换时机 | 在工作流开始前进行预处理 |

### 1.3 数据示例

```sql
-- 产品信息表（字典表）
CREATE TABLE `prod_info` (
  `prod_id` bigint DEFAULT NULL COMMENT '产品ID',
  `prod_name` varchar(100) DEFAULT NULL COMMENT '产品名称'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 数据：
-- prod_id | prod_name
-- --------|----------
-- 1001    | 云总机
-- 1002    | 工作号

-- 业务配置表
CREATE TABLE `special_settlement_rule_config` (
  `PROD_ID` varchar(64) NOT NULL COMMENT '产品ID',
  ...
) ENGINE=InnoDB;
```

---

## 2. 架构设计

### 2.1 工作流变更

**变更前：**
```
用户问题 → intent_node → schema_node → ...
```

**变更后：**
```
用户问题 → preprocessing_node → intent_node → schema_node → ...
            ↑
        字典值转换
```

### 2.2 目录结构

```
langchain_chatbi/
├── dictionary/                    # 新增：字典模块
│   ├── __init__.py
│   ├── dictionary_service.py      # 核心服务类
│   └── models.py                  # Pydantic 数据模型
├── config/                        # 新增：配置目录
│   ├── dictionary_config.yaml     # 字典定义
│   └── synonym_config.yaml        # 同义词映射
├── graph/
│   ├── state.py                   # 修改：添加转换字段
│   ├── nodes.py                   # 修改：添加预处理节点
│   └── workflow.py                # 修改：更新入口点
├── web/
│   └── app.py                     # 修改：初始化字典服务
└── tests/
    ├── test_dictionary_service.py      # 新增：单元测试
    └── test_dictionary_workflow_integration.py  # 新增：集成测试
```

---

## 3. 数据模型设计

### 3.1 字典配置 (dictionary_config.yaml)

```yaml
dictionaries:
  - name: product_dict
    description: "产品名称到ID的映射"
    source_type: database          # 或 static
    cache_ttl_seconds: 3600        # 缓存1小时
    source_config:
      type: database
      table: prod_info
      key_column: prod_id
      value_column: prod_name
      # where_clause: "status = 'active'"  # 可选过滤条件

  - name: status_dict
    description: "状态名称到编码的映射"
    source_type: static
    cache_ttl_seconds: 7200        # 缓存2小时
    source_config:
      type: static
      mappings:
        "启用": "1000"
        "禁用": "1001"
```

### 3.2 同义词配置 (synonym_config.yaml)

```yaml
synonym_groups:
  - dictionary_name: product_dict
    canonical_value: "云总机"
    synonyms:
      - "云总机服务"
      - "云总机产品"
      - "企业云总机"

  - dictionary_name: product_dict
    canonical_value: "工作号"
    synonyms:
      - "工作号服务"
      - "企业工作号"
```

### 3.3 状态扩展

```python
class ChatBIState(MessagesState):
    # 新增字段
    original_question: Optional[str]      # 原始问题
    transformed_question: Optional[str]   # 转换后的问题
    dictionary_transformations: Optional[Dict[str, Any]]  # 转换记录
```

---

## 4. 核心类设计

### 4.1 DictionaryService

```python
class DictionaryService:
    """字典值转换服务"""

    async def initialize(self):
        """加载配置并预热缓存"""

    async def transform(
        self,
        text: str,
        dictionary_names: Optional[List[str]] = None
    ) -> Tuple[str, Dict[str, Any]]:
        """
        转换文本中的业务名称为编码值

        返回: (转换后的文本, 转换元数据)
        """

    async def reverse_lookup(
        self,
        key: Any,
        dictionary_name: str
    ) -> Optional[str]:
        """反向查找：编码 → 业务名称"""
```

### 4.2 缓存策略

```
Level 1: 内存缓存 {display_name: id}
├── TTL: 可配置（默认3600秒）
└── 刷新: 主动刷新 + 过期自动刷新

Level 2: 同义词索引 {synonym: canonical_value}
└── 与主缓存同步更新

降级策略:
├── 缓存刷新失败 → 使用过期缓存
└── 完全无数据 → 返回原始文本
```

---

## 5. 转换示例

| 输入 | 输出 | 说明 |
|------|------|------|
| `云总机有哪些配置` | `1001有哪些配置` | 基本转换 |
| `云总机服务有哪些配置` | `1001有哪些配置` | 同义词转换 |
| `云总机和工作号的配置` | `1001和1002的配置` | 多值转换 |
| `未知产品有哪些配置` | `未知产品有哪些配置` | 无匹配（保持原样） |

---

## 6. API 使用

### 6.1 初始化服务

```python
from langchain_chatbi.dictionary import get_dictionary_service

# 获取单例服务
dictionary_service = get_dictionary_service(
    config_path="config/dictionary_config.yaml",
    synonym_path="config/synonym_config.yaml",
    db_connection=mysql_conn
)

# 初始化（加载配置和预热缓存）
await dictionary_service.initialize()
```

### 6.2 工作流集成

```python
# 在 workflow config 中传递字典服务
config = {
    "configurable": {
        "dictionary_service": dictionary_service,
        "db": mysql_conn
    }
}

# 工作流会自动在 preprocessing_node 中执行转换
async for event in graph.astream(initial_state, config=config):
    # ...
```

---

## 7. 文件清单

### 7.1 新增文件

| 文件 | 行数 | 描述 |
|------|------|------|
| `dictionary/__init__.py` | 25 | 模块导出 |
| `dictionary/dictionary_service.py` | ~330 | 核心服务实现 |
| `dictionary/models.py` | ~115 | Pydantic 数据模型 |
| `config/dictionary_config.yaml` | ~30 | 字典配置 |
| `config/synonym_config.yaml` | ~20 | 同义词配置 |
| `tests/test_dictionary_service.py` | ~200 | 单元测试 |
| `tests/test_dictionary_workflow_integration.py` | ~180 | 集成测试 |

### 7.2 修改文件

| 文件 | 修改内容 |
|------|---------|
| `graph/state.py` | 添加3个字段 |
| `graph/nodes.py` | 添加 `preprocessing_node` 和 `_get_effective_question()` |
| `graph/workflow.py` | 更新入口点和边定义 |
| `web/app.py` | 初始化字典服务并传递给工作流 |

---

## 8. 测试覆盖

### 8.1 单元测试 (9个测试用例)

```bash
$ python -m pytest tests/test_dictionary_service.py -v

tests/test_dictionary_service.py::test_dictionary_initialization PASSED
tests/test_dictionary_service.py::test_basic_transformation PASSED
tests/test_dictionary_service.py::test_synonym_transformation PASSED
tests/test_dictionary_service.py::test_multiple_transformation PASSED
tests/test_dictionary_service.py::test_no_match PASSED
tests/test_dictionary_service.py::test_specific_dictionary PASSED
tests/test_dictionary_service.py::test_reverse_lookup PASSED
tests/test_dictionary_service.py::test_cache_expiration PASSED
tests/test_dictionary_service.py::test_sync_transform PASSED

======================== 9 passed in 2.15s ========================
```

### 8.2 集成测试

测试完整工作流中的字典转换功能。

---

## 9. 性能考虑

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 转换延迟 | < 10ms | 命中缓存的情况 |
| 缓存预热 | < 100ms | 启动时加载所有字典 |
| 内存占用 | < 10MB | 假设10000条字典数据 |

---

## 10. 未来扩展

### 10.1 可能的增强

- [ ] 模糊匹配支持（Levenshtein 距离）
- [ ] 多语言同义词
- [ ] 自动从数据库元数据发现字典表
- [ ] 分布式缓存（Redis）
- [ ] 管理界面（CRUD 字典配置）

### 10.2 使用建议

1. **字典表设计**: 建议使用单独的字典表，避免在业务表中添加太多同义词
2. **缓存TTL**: 根据数据变更频率调整，建议不低于1小时
3. **同义词管理**: 避免循环引用，同义词不应与其他标准值冲突

---

## 11. 关键文件路径

```
langchain_chatbi/
├── dictionary/dictionary_service.py       # 核心服务
├── config/dictionary_config.yaml          # 字典配置
├── config/synonym_config.yaml             # 同义词配置
├── graph/nodes.py                         # 预处理节点
├── graph/state.py                         # 状态定义
└── graph/workflow.py                      # 工作流编排
```

---

*文档版本: 1.0*
*创建日期: 2026-01-28*
*作者: Claude Code*
