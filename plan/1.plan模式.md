# Plan 模式使用指南

## 什么是 Plan 模式

Plan 模式是 Claude Code 中的规划和设计模式。当你需要实现复杂功能或做出架构决策时，Claude 会进入 Plan 模式，先探索代码库、设计方案，然后等待你的批准后再开始实施。

## 何时进入 Plan 模式

Claude 会在以下情况下主动进入 Plan 模式：

### 适用场景

| 场景 | 说明 | 示例 |
|------|------|------|
| **新功能实现** | 需要做出架构决策 | 添加用户认证、实现缓存系统 |
| **多种可行方案** | 任务有多种解决方式 | 优化性能（有多种策略可选） |
| **代码修改** | 影响现有行为或结构 | 修改登录流程、重构组件 |
| **架构决策** | 需要在模式/技术间选择 | 实现 WebSockets vs SSE |
| **多文件变更** | 涉及 2-3 个以上文件 | 重构认证系统、添加新 API 端点 |
| **需求不明确** | 需要先探索理解范围 | "让应用更快"、"修复 checkout 的 bug" |
| **用户偏好重要** | 有多种合理实现方式 | 实现主题切换（Redux vs Context） |

### 不适用场景

- **简单修复** - 单行或少量代码改动（错别字、明显 bug）
- **明确任务** - 需求非常具体的单一函数
- **纯研究** - 探索代码库结构（使用 Explore agent）
- **信息查询** - 例如 "路由是如何工作的？"

## 进入 Plan 模式的方式

### 1. Claude 主动进入

当你的任务符合上述适用场景时，Claude 会自动调用 `EnterPlanMode` 工具：

```
User: 帮我添加用户认证功能
Assistant: 我需要先探索代码库并设计实现方案，让我进入 plan 模式。
         [调用 EnterPlanMode]
```

### 2. 手动触发

使用斜杠命令：

```
/plan
```

## Plan 模式工作流程

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   1. 探索阶段    │ -> │   2. 设计方案    │ -> │   3. 呈现计划    │
│  - Glob/Grep    │    │  - 理解现有模式  │    │  - 等待用户批准  │
│  - Read 文件    │    │  - 制定实现步骤  │    │  - ExitPlanMode │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                               |
                                                               v
                                                        ┌─────────────────┐
                                                        │   4. 开始实施    │
                                                        │  - 编写代码      │
                                                        │  - 测试验证      │
                                                        └─────────────────┘
```

### 阶段说明

#### 1. 探索阶段
Claude 使用以下工具探索代码库：
- **Glob** - 查找文件模式（如 `**/*.ts`）
- **Grep** - 搜索代码内容
- **Read** - 读取具体文件

#### 2. 设计方案
- 理解现有架构和代码风格
- 制定详细的实现计划
- 识别需要修改的关键文件

#### 3. 呈现计划
- 向用户展示完整的实现方案
- 说明每个步骤的目的
- 使用 `ExitPlanMode` 请求批准

#### 4. 开始实施
- 获得批准后执行计划
- 使用 TodoWrite 跟踪进度
- 逐步完成各项任务

## 与 AskUserQuestion 的区别

| 特性 | Plan 模式 | AskUserQuestion |
|------|-----------|-----------------|
| **用途** | 设计实现方案 | 澄清具体选择 |
| **时机** | 实现前探索 | 在探索后澄清 |
| **输出** | 完整实施计划 | 单一决策点 |
| **示例** | "如何实现认证？" | "使用 OAuth 还是 JWT？" |

**重要**: 不要用 `AskUserQuestion` 询问 "计划可以吗？" 或 "我应该继续吗？" - 这正是 `ExitPlanMode` 的用途。

## 示例

### 示例 1: 添加认证功能

```
User: 帮我添加用户认证功能
Assistant: 我需要先探索代码库并设计实现方案。
         [进入 Plan 模式，探索现有代码]
         [设计认证方案：使用 JWT + 中间件]
         [调用 ExitPlanMode 呈现计划]
User: [批准计划]
Assistant: [开始实施，创建认证中间件、路由、测试]
```

### 示例 2: 性能优化

```
User: 应用运行很慢，帮我优化
Assistant: 我需要先分析代码找出性能瓶颈，然后设计优化方案。
         [进入 Plan 模式]
         [分析组件渲染、数据获取等]
         [设计方案：虚拟化、memoization、图片优化]
         [调用 ExitPlanMode]
```

## 注意事项

- **需要用户批准** - Plan 模式必须经过你同意才能退出
- **保持简洁** - 计划应聚焦于完成任务，不过度设计
- **遵循现有模式** - 设计方案应尊重代码库现有架构
- **可分步执行** - 计划应分解为可管理的步骤

## 相关工具

- `EnterPlanMode` - 进入 Plan 模式
- `ExitPlanMode` - 退出 Plan 模式并请求批准
- `AskUserQuestion` - 在 Plan 模式内澄清用户偏好
- `TodoWrite` - 在实施阶段跟踪任务进度
